<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>금 AI 분석시스템 | GOLD NAKAMA</title>
    
    <!-- PWA 필수 설정 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2489/2489756.png">

    <!-- 외부 라이브러리 (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scale-in-center { animation: scale-in-center 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes scale-in-center {
          0% { transform: scale(0); opacity: 1; }
          100% { transform: scale(1); opacity: 1; }
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee { display: flex; animation: marquee 30s linear infinite; }
        @keyframes scroll-left {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); }
        }
        .animate-scroll-left { animation: scroll-left 30s linear infinite; }
        .btn-active-glow {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            animation: pulse-amber 2s infinite;
        }
        @keyframes pulse-amber {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // 아이콘 컴포넌트 래퍼
        const Icon = ({ name, size = 24, className = "" }) => {
            const getIconContent = (iconName) => {
                if (!window.lucide) return null;
                const camelName = iconName.charAt(0).toUpperCase() + iconName.slice(1).replace(/-([a-z])/g, g => g[1].toUpperCase());
                const iconDef = window.lucide.icons ? window.lucide.icons[camelName] : window.lucide[camelName];
                if (iconDef && Array.isArray(iconDef) && iconDef[2]) {
                    return iconDef[2].map((child, i) => {
                        if (!Array.isArray(child) || !child[0]) return null;
                        return React.createElement(child[0], { key: i, ...child[1] });
                    });
                }
                return null;
            };
            const content = useMemo(() => getIconContent(name), [name]);
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {content}
                </svg>
            );
        };

        const App = () => {
            const apiKey = "AIzaSyAO8PsCWMq0xLtiywqqK90AD1NHP_84-us"; 
            const KAKAO_TALK_LINK = "https://open.kakao.com/o/sDqGhjGb";
            const HS_GOLD_LINK = "http://www.jaeilgoldhs.co.kr/";
            const PHONE_NUMBER = "010-2386-6630";

            const [image, setImage] = useState(null);
            const [croppedImage, setCroppedImage] = useState(null);
            const [base64Image, setBase64Image] = useState(null);
            const [prediction, setPrediction] = useState(null);
            const [location, setLocation] = useState("서울 종로구"); 
            const [nearbyExchanges, setNearbyExchanges] = useState([]);
            const [isExchangesLoading, setIsExchangesLoading] = useState(false);
            
            const [unit, setUnit] = useState('돈'); 
            const [inputValue, setInputValue] = useState(1);
            const [weightInGrams, setWeightInGrams] = useState(3.75);
            const [isCropping, setIsCropping] = useState(false);
            const [crop, setCrop] = useState({ x: 25, y: 25, width: 50, height: 50 });
            
            const [isNoticeOpen, setIsNoticeOpen] = useState(true); 
            const [isAdOpen, setIsAdOpen] = useState(false);
            const [adTimer, setAdTimer] = useState(15);
            const [isAnalysisComplete, setIsAnalysisComplete] = useState(false);
            const [isImageProcessing, setIsImageProcessing] = useState(false);
            const [isConsultConfirmOpen, setIsConsultConfirmOpen] = useState(false);
            const [isAlarmSettingOpen, setIsAlarmSettingOpen] = useState(false);

            const [isLandscape, setIsLandscape] = useState(false);
            const [isMobileDevice, setIsMobileDevice] = useState(false);

            const [krxPricePerGram, setKrxPricePerGram] = useState(125000); 
            const [isPriceLoading, setIsPriceLoading] = useState(false);
            const [alarmTime, setAlarmTime] = useState(() => localStorage.getItem('gold_alarm_time') || "09:00");
            const [isAlarmOn, setIsAlarmOn] = useState(() => localStorage.getItem('gold_alarm_on') === 'true');
            const [activeAlarm, setActiveAlarm] = useState(false);

            const [exchangePrices, setExchangePrices] = useState({
                jongro: { label: '종로금거래소', val: 462000, color: 'bg-amber-100 text-amber-700' },
                koreaGold: { label: '한국금거래소', val: 461000, color: 'bg-slate-100 text-slate-700' },
                standard: { label: '표준금거래소', val: 463000, color: 'bg-blue-100 text-blue-700' }
            });

            const callGemini = async (payload) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return await response.json();
                    throw new Error(`HTTP Error: ${response.status}`);
                } catch (err) { throw err; }
            };

            const fetchNearbyExchanges = useCallback(async (loc) => {
                setIsExchangesLoading(true);
                try {
                    const data = await callGemini({
                        contents: [{ parts: [{ text: `${loc} 근처의 실제 운영 중인 금거래소 3곳을 JSON 배열로 알려주세요: [{"name": "이름", "rating": 4.5, "address": "주소"}]` }] }],
                        tools: [{ "google_search": {} }],
                        generationConfig: { responseMimeType: "application/json" }
                    });
                    const txt = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (txt) setNearbyExchanges(JSON.parse(txt));
                } catch (e) {
                    setNearbyExchanges([
                        { name: "종로 금 매입 센터", rating: 4.9, address: "서울 종로구 묘동" },
                        { name: "한국 금 거래소 본점", rating: 4.8, address: "서울 종로구 돈의동" }
                    ]);
                } finally { setIsExchangesLoading(false); }
            }, []);

            const fetchAddress = useCallback(async (lat, lon) => {
                try {
                    const data = await callGemini({
                        contents: [{ parts: [{ text: `위도 ${lat}, 경도 ${lon}의 주소를 '시 구 동' 까지만 알려주세요.` }] }]
                    });
                    const addr = (data.candidates?.[0]?.content?.parts?.[0]?.text || "서울 종로구").trim();
                    setLocation(addr);
                    fetchNearbyExchanges(addr);
                } catch { fetchNearbyExchanges(location); }
            }, [location, fetchNearbyExchanges]);

            const fetchKrxGoldPrice = useCallback(async () => {
                setIsPriceLoading(true);
                try {
                    const data = await callGemini({
                        contents: [{ parts: [{ text: "오늘 KRX 금 시장의 실시간 1g당 매매 기준가(숫자만)" }] }],
                        tools: [{ "google_search": {} }]
                    });
                    const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const price = parseInt(txt.replace(/[^0-9]/g, ''));
                    if (!isNaN(price) && price > 50000) {
                        setKrxPricePerGram(price);
                        setExchangePrices({
                            jongro: { label: '종로금거래소', val: Math.floor(price * 3.75 * 0.985), color: 'bg-amber-100 text-amber-700' },
                            koreaGold: { label: '한국금거래소', val: Math.floor(price * 3.75 * 0.98), color: 'bg-slate-100 text-slate-700' },
                            standard: { label: '표준금거래소', val: Math.floor(price * 3.75 * 0.988), color: 'bg-blue-100 text-blue-700' }
                        });
                    }
                } catch (e) { console.error(e); }
                finally { setIsPriceLoading(false); }
            }, []);

            useEffect(() => {
                const checkEnv = () => {
                    const ua = navigator.userAgent.toLowerCase();
                    setIsMobileDevice(/android|iphone|ipad|ipod/.test(ua) || ('ontouchstart' in window));
                    setIsLandscape(window.innerWidth > window.innerHeight);
                };
                checkEnv();
                window.addEventListener('resize', checkEnv);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => fetchAddress(pos.coords.latitude, pos.coords.longitude),
                        () => fetchNearbyExchanges(location)
                    );
                } else { fetchNearbyExchanges(location); }
                fetchKrxGoldPrice();
                return () => window.removeEventListener('resize', checkEnv);
            }, []);

            useEffect(() => {
                const interval = setInterval(() => {
                    if (!isAlarmOn) return;
                    const now = new Date();
                    const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                    if (timeStr === alarmTime && now.getSeconds() === 0) setActiveAlarm(true);
                }, 1000);
                return () => clearInterval(interval);
            }, [isAlarmOn, alarmTime]);

            const getStandardPricePerDon = () => {
                const raw = krxPricePerGram * 3.75;
                const deducted = raw * (1 - 0.025);
                return Math.floor(deducted / 1000) * 1000;
            };

            const getAlarmPriceList = () => {
                const std = getStandardPricePerDon();
                return [
                    { label: '24K 순금', val: std },
                    { label: '18K 금', val: Math.floor(std * 0.75 / 1000) * 1000 },
                    { label: '14K 금', val: Math.floor(std * 0.585 / 1000) * 1000 },
                    { label: '플래티넘', val: Math.floor(std * 0.8 / 1000) * 1000 }
                ];
            };

            const calculatePrice = () => {
                if (!prediction || !prediction.purity) return "0";
                const base = getStandardPricePerDon();
                let ratio = 0.5;
                const p = String(prediction.purity).toUpperCase();
                if (p.includes('24K')) ratio = 1.0;
                else if (p.includes('18K')) ratio = 0.75;
                else if (p.includes('14K')) ratio = 0.585;
                else if (p.includes('은')) ratio = 0.02;
                else if (p.includes('PT')) ratio = 0.8;
                return Math.floor((base / 3.75) * weightInGrams * ratio).toLocaleString();
            };

            const resetApp = () => {
                setImage(null); setCroppedImage(null); setPrediction(null);
                setIsCropping(false); setInputValue(1); setWeightInGrams(3.75); setUnit('돈');
                setIsAnalysisComplete(false); window.scrollTo(0,0);
            };

            const handleImage = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImageProcessing(true);
                const reader = new FileReader();
                reader.onload = (ev) => { setImage(ev.target.result); setIsCropping(true); setIsImageProcessing(false); };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const getCroppedImg = () => {
                const img = new Image();
                img.src = image;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    const sw = crop.width * img.naturalWidth / 100;
                    const sh = crop.height * img.naturalHeight / 100;
                    cvs.width = sw; cvs.height = sh;
                    ctx.drawImage(img, crop.x * img.naturalWidth / 100, crop.y * img.naturalHeight / 100, sw, sh, 0, 0, sw, sh);
                    const b64 = cvs.toDataURL('image/jpeg', 0.85);
                    setCroppedImage(b64); setBase64Image(b64.split(',')[1]); setIsCropping(false);
                };
            };

            const startAnalysis = async () => {
                if (!base64Image) return;
                setIsAdOpen(true); setAdTimer(15); setIsAnalysisComplete(false);
                const tmr = setInterval(() => setAdTimer(p => p <= 1 ? (clearInterval(tmr), 0) : p - 1), 1000);
                try {
                    const data = await callGemini({
                        contents: [{ parts: [
                            { text: `이미지를 정밀 분석하여 다음 JSON으로 응답하세요: { "material": "금/은/기타", "productName": "제품명", "purity": "함량(24K/18K/14K 등)", "reason": "이유" }` },
                            { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                        ]}],
                        generationConfig: { responseMimeType: "application/json" }
                    });
                    setPrediction(JSON.parse(data.candidates[0].content.parts[0].text));
                    setIsAnalysisComplete(true);
                } catch (e) {
                    setPrediction({ error: true, reason: "분석 실패" });
                    setIsAnalysisComplete(true);
                }
            };

            return (
                <div className="pb-32 select-none min-h-screen">
                    {/* 모달 및 경고 */}
                    {isNoticeOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-sm w-full text-center">
                                <Icon name="alert-circle" size={40} className="text-amber-500 mx-auto mb-4" />
                                <h3 className="text-xl font-bold mb-2">AI 분석 주의사항</h3>
                                <p className="text-sm text-slate-500 mb-6 leading-relaxed">AI 결과는 참고용입니다. 정확한 가격은 실물 감정 후 결정됩니다.</p>
                                <button onClick={() => setIsNoticeOpen(false)} className="w-full bg-amber-500 text-white py-4 rounded-2xl font-bold">확인</button>
                            </div>
                        </div>
                    )}

                    {/* 알람 팝업 */}
                    {activeAlarm && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden">
                                <div className="bg-amber-500 p-6 text-white text-center"><h3 className="text-2xl font-black">시세 알림</h3></div>
                                <div className="p-6 space-y-2">
                                    {getAlarmPriceList().map((item, i) => (
                                        <div key={i} className="flex justify-between p-3 bg-slate-50 rounded-xl">
                                            <span className="font-bold text-slate-600">{item.label}</span>
                                            <span className="font-black">₩ {item.val.toLocaleString()}</span>
                                        </div>
                                    ))}
                                    <button onClick={() => setActiveAlarm(false)} className="w-full mt-4 py-4 bg-slate-900 text-white rounded-2xl">확인</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 헤더 */}
                    <nav className="bg-white border-b sticky top-0 z-40 max-w-md mx-auto shadow-sm">
                        <div className="px-5 py-4 flex justify-between items-center">
                            <h1 className="font-black text-xl flex items-center gap-1 cursor-pointer" onClick={resetApp}>
                                <Icon name="coins" size={24} className="text-amber-500" /> 금 AI 분석
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={() => setIsAlarmSettingOpen(true)} className={`p-2 rounded-xl ${isAlarmOn ? 'text-amber-500 bg-amber-50' : 'text-slate-400'}`}><Icon name="bell" size={20}/></button>
                                <div onClick={() => window.open(HS_GOLD_LINK)} className="bg-slate-900 text-white px-3 py-2 rounded-xl text-xs font-black cursor-pointer">제일금거래소</div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto p-5 space-y-5">
                        {/* 시세 보드 */}
                        <section className="bg-slate-900 p-6 rounded-[2rem] text-white shadow-xl">
                            <p className="text-[10px] font-black text-amber-500 uppercase mb-1">Standard Rate</p>
                            <h2 className="text-4xl font-black italic">₩ {getStandardPricePerDon().toLocaleString()}</h2>
                            <p className="text-[9px] text-slate-400 mt-2">오늘의 1돈 매입 기준가 (2.5% 차감)</p>
                        </section>

                        {/* 업로드 섹션 */}
                        <section className="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100 text-center">
                            {!image ? (
                                <div className="aspect-[16/7] border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 bg-slate-50 relative">
                                    <Icon name="camera" size={32} className="text-amber-500" />
                                    <p className="text-xs font-black">제품 촬영 및 업로드</p>
                                    <input type="file" accept="image/*" capture="environment" onChange={handleImage} className="absolute inset-0 opacity-0" />
                                </div>
                            ) : isCropping ? (
                                <div className="space-y-4">
                                    <div className="aspect-video bg-slate-900 rounded-2xl relative overflow-hidden">
                                        <img src={image} className="w-full h-full object-contain opacity-50" />
                                        <div className="absolute border-4 border-amber-500" style={{ left: `${crop.x}%`, top: `${crop.y}%`, width: `${crop.width}%`, height: `${crop.height}%` }}></div>
                                    </div>
                                    <button onClick={getCroppedImg} className="w-full bg-amber-500 text-white py-4 rounded-xl font-black">영역 확정</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <img src={croppedImage} className="w-full h-44 object-cover rounded-2xl" />
                                    <div className="flex items-center justify-center gap-3">
                                        <input type="number" value={inputValue} onChange={e => setInputValue(e.target.value)} className="w-20 text-center font-black text-3xl border-b-2 border-amber-500 outline-none" />
                                        <span className="font-black text-xl">{unit}</span>
                                    </div>
                                    <button onClick={startAnalysis} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black">AI 정밀 분석 시작</button>
                                </div>
                            )}
                        </section>

                        {/* 결과 출력 */}
                        {prediction && !isAdOpen && (
                            <section className="bg-white rounded-[2rem] p-6 shadow-xl border-2 border-amber-500 scale-in-center">
                                <div className="bg-slate-900 rounded-2xl p-5 text-center">
                                    <p className="text-[10px] text-amber-500 uppercase mb-1">Estimated Value</p>
                                    <h4 className="text-3xl font-black text-white italic">₩ {calculatePrice()}</h4>
                                </div>
                                <div className="mt-4 space-y-2">
                                    <p className="text-sm font-black text-center">{prediction.purity} {prediction.productName}</p>
                                    <p className="text-xs text-slate-500 text-center italic">{prediction.reason}</p>
                                </div>
                                <button onClick={() => setIsConsultConfirmOpen(true)} className="w-full mt-4 bg-amber-500 text-white py-4 rounded-xl font-black">상담 연결</button>
                            </section>
                        )}

                        {/* 실시간 시세 리스트 */}
                        <section className="space-y-3">
                           <div className="relative w-full overflow-hidden">
                             <div className="flex w-fit animate-scroll-left">
                               {[...Object.values(exchangePrices), ...Object.values(exchangePrices)].map((item, idx) => (
                                 <div key={idx} className="min-w-[150px] mx-2 bg-white border rounded-3xl p-5 shadow-sm">
                                    <div className={`inline-block px-2 py-0.5 rounded-full ${item.color} text-[10px] font-black mb-1`}>{item.label}</div>
                                    <p className="text-lg font-black text-slate-900">₩ {item.val.toLocaleString()}</p>
                                 </div>
                               ))}
                             </div>
                           </div>
                        </section>
                    </main>

                    {/* 알람 설정 모달 */}
                    {isAlarmSettingOpen && (
                        <div className="fixed inset-0 z-[600] flex items-center justify-center bg-black/60 p-4">
                            <div className="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-black">시세 알림 설정</h3>
                                    <button onClick={() => setIsAlarmSettingOpen(false)}><Icon name="x" size={24}/></button>
                                </div>
                                <div className="space-y-6 text-center">
                                    <input type="time" value={alarmTime} onChange={(e) => {setAlarmTime(e.target.value); localStorage.setItem('gold_alarm_time', e.target.value)}} className="w-full p-4 bg-slate-50 rounded-2xl text-center text-3xl font-black border"/>
                                    <button onClick={() => {setIsAlarmOn(!isAlarmOn); localStorage.setItem('gold_alarm_on', !isAlarmOn)}} className={`w-full py-4 rounded-2xl font-black ${isAlarmOn ? 'bg-amber-500 text-white' : 'bg-slate-200'}`}>
                                        {isAlarmOn ? '알림 켜짐' : '알림 꺼짐'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 광고 모달 */}
                    {isAdOpen && (
                        <div className="fixed inset-0 z-[700] flex items-center justify-center bg-slate-900/95 p-4">
                            <div className="bg-white rounded-[3rem] p-8 max-w-sm w-full text-center shadow-2xl relative">
                                <div className="absolute top-0 left-0 w-full h-2 bg-slate-100">
                                    <div className="h-full bg-amber-500" style={{ width: `${((15-adTimer)/15)*100}%` }}></div>
                                </div>
                                <Icon name="shield-check" size={56} className="text-amber-500 mx-auto mb-6 mt-4" />
                                <h4 className="text-2xl font-black mb-2 uppercase">AI 분석 가동 중</h4>
                                <p className="text-sm text-slate-400 mb-8">잠시만 기다려주세요... {adTimer}s</p>
                                {isAnalysisComplete && (
                                    <button onClick={() => setIsAdOpen(false)} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl btn-active-glow">결과 확인하기</button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* 하단 바 */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-5 z-40">
                        <div className="bg-slate-900/95 backdrop-blur-xl p-3 rounded-[2.2rem] flex items-center justify-between border border-white/10 shadow-2xl">
                            <div className="flex items-center gap-3 ml-2 text-white">
                                <Icon name="phone" size={22} className="text-amber-500 animate-pulse"/>
                                <span className="text-xs font-black">{PHONE_NUMBER}</span>
                            </div>
                            <button onClick={() => window.open(KAKAO_TALK_LINK)} className="bg-amber-500 text-slate-900 px-7 py-3.5 rounded-2xl font-black text-xs">문의하기</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>