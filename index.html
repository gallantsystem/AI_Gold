<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>금 AI 분석</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="금 AI 분석">
    
    <!-- Manifest (PWA 필수 설정) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJnameIjogIuq4iCBBSSDrtoTshJ0iLAogICJzaG9ydF9uYW1lIjogIuq4iCBBSSIsCiAgInN0YXJ0X3VybCI6ICIuL2luZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImJhY2tncm91bmRfY29sb3ciOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yNzIxLzI3MjEyOTAucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .marquee { overflow: hidden; white-space: nowrap; width: 100%; }
        .marquee-content { display: inline-block; animation: marquee 15s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-200%); } }
        
        .bottom-nav-item.active { color: #b8860b; font-weight: bold; }
        
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-left-color: #fbbf24; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { width: 100%; max-width: 400px; background: white; border-radius: 32px; padding: 24px; animation: fadeIn 0.3s ease-out; position: relative; overflow: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .preview-container { display: flex; justify-content: center; width: 100%; margin: 1rem 0; }
        .preview-square { width: 66.6%; aspect-ratio: 1/1; border-radius: 24px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); }
        .preview-square img { width: 100%; height: 100%; object-fit: cover; object-position: center; }

        .crop-modal-content { width: 95%; max-width: 500px; padding: 0; }
        .crop-area { width: 100%; height: 350px; background: #000; }
        #crop-image { max-width: 100%; display: block; }
        
        main { flex: 1; overflow-y: auto; padding-bottom: 140px; }
        
        #pwa-prompt { display: none; }
        #pwa-prompt.visible { display: flex; }
    </style>
</head>
<body>

    <!-- PWA Install Prompt -->
    <div id="pwa-prompt" class="fixed top-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl z-[60] flex items-center justify-between shadow-2xl">
        <div class="flex items-center">
            <div class="w-10 h-10 bg-yellow-400 rounded-lg flex items-center justify-center mr-3 text-gray-900">
                <i class="fas fa-coins"></i>
            </div>
            <div>
                <p class="text-xs font-bold">홈 화면에 추가</p>
                <p class="text-[10px] text-gray-400">앱으로 설치하여 시세를 확인하세요</p>
            </div>
        </div>
        <button id="pwa-install-btn" class="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold">설치</button>
    </div>

    <header class="bg-white sticky top-0 z-50 shadow-sm shrink-0">
        <div class="px-4 py-3 flex items-center justify-between gap-2">
            <h1 class="text-base font-black text-gray-900 shrink-0">금 AI 분석</h1>
            <div id="location-display" class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 flex items-center shrink-0">
                <i class="fas fa-location-arrow mr-1 text-blue-500"></i> <span>위치 확인 중</span>
            </div>
            <a href="http://www.jaeilgoldhs.co.kr/" target="_blank" class="flex-1 bg-yellow-400 text-[11px] font-bold py-1.5 px-3 rounded-full text-center truncate shadow-sm">
                금팔러가기 <i class="fas fa-chevron-right text-[9px] ml-0.5"></i>
            </a>
        </div>
    </header>

    <main class="px-5 mt-4 space-y-6">
        <!-- AI Analyzer Section -->
        <section id="ai-view" class="space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-base font-bold">AI 함량 분석</h2>
                        <p class="text-[10px] text-gray-400">사진 한 장으로 금 함량을 분석합니다.</p>
                    </div>
                </div>

                <div id="image-display-area" class="hidden">
                    <div class="preview-container">
                        <div class="preview-square border-4 border-white">
                            <img id="main-preview-img" src="">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-2xl border-2 border-transparent focus-within:border-blue-500 transition-all">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">무게 (돈)</label>
                        <input type="number" id="weight-input" value="1" step="0.01" class="bg-transparent border-0 w-full text-2xl font-black outline-none">
                    </div>

                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button id="main-action-btn" onclick="document.getElementById('image-input').click()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg flex items-center justify-center space-x-3">
                        <i class="fas fa-camera"></i>
                        <span>사진 등록하기</span>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t flex justify-around items-center h-20 px-1 z-50">
        <button class="bottom-nav-item flex flex-col items-center flex-1 active">
            <i class="fas fa-microchip text-xl mb-1"></i><span class="text-[9px]">AI 분석</span>
        </button>
        <a href="tel:031-356-1077" class="bottom-nav-item flex flex-col items-center flex-1 text-red-500">
            <i class="fas fa-phone-alt text-xl mb-1"></i><span class="text-[9px]">전화상담</span>
        </a>
    </nav>

    <!-- Crop Modal -->
    <div id="crop-modal" class="modal">
        <div class="modal-content crop-modal-content">
            <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
                <span class="text-sm font-bold">금 부위 선택</span>
                <button onclick="closeCropModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="crop-area"><img id="crop-image" src=""></div>
            <div class="p-4 bg-white">
                <button onclick="applyCrop()" class="w-full py-4 bg-yellow-400 text-gray-900 font-black rounded-xl">분석 부위 확정</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // 1. Service Worker Registration (PWA 필수)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => self.skipWaiting());
                    self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request).catch(() => {})));
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }

        // 2. PWA Install Logic
        let deferredPrompt;
        const pwaPrompt = document.getElementById('pwa-prompt');
        const installBtn = document.getElementById('pwa-install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            pwaPrompt.classList.add('visible');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') pwaPrompt.classList.remove('visible');
                deferredPrompt = null;
            }
        });

        // 3. UI Logic (기존 기능 유지)
        let fullImageBase64 = null;
        let cropper = null;

        const imageInput = document.getElementById('image-input');
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('crop-image').src = event.target.result;
                document.getElementById('crop-modal').classList.add('active');
                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(document.getElementById('crop-image'), { viewMode: 1, aspectRatio: 1 });
                }, 100);
            };
            reader.readAsDataURL(file);
        });

        function closeCropModal() {
            document.getElementById('crop-modal').classList.remove('active');
            imageInput.value = "";
        }

        function applyCrop() {
            const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
            fullImageBase64 = canvas.toDataURL('image/jpeg');
            document.getElementById('image-display-area').classList.remove('hidden');
            document.getElementById('main-preview-img').src = fullImageBase64;
            closeCropModal();
        }
    </script>
</body>
</html>
