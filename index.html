<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>금 AI 분석</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="금 AI 분석">
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .marquee { overflow: hidden; white-space: nowrap; width: 100%; }
        .marquee-content { display: inline-block; animation: marquee 15s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-200%); } }
        
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-left-color: #fbbf24; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { width: 100%; max-width: 400px; background: white; border-radius: 32px; padding: 24px; animation: fadeIn 0.3s ease-out; position: relative; overflow: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .preview-container { display: flex; justify-content: center; width: 100%; margin: 1rem 0; }
        .preview-square { width: 66.6%; aspect-ratio: 1/1; border-radius: 24px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); }
        .preview-square img { width: 100%; height: 100%; object-fit: cover; }

        .crop-area { width: 100%; height: 350px; background: #000; }
        #crop-image { max-width: 100%; display: block; }
        
        main { flex: 1; overflow-y: auto; padding-bottom: 140px; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white sticky top-0 z-50 shadow-sm shrink-0">
        <div class="px-4 py-3 flex items-center justify-between gap-2">
            <h1 class="text-base font-black text-gray-900 shrink-0">금 AI 분석</h1>
            <div id="location-display" class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 flex items-center shrink-0">
                <i class="fas fa-location-arrow mr-1 text-blue-500"></i> <span>위치 확인 중</span>
            </div>
            <a href="http://www.jaeilgoldhs.co.kr/" target="_blank" class="flex-1 bg-yellow-400 text-[11px] font-bold py-1.5 px-3 rounded-full text-center truncate shadow-sm">
                금팔러가기 <i class="fas fa-chevron-right text-[9px] ml-0.5"></i>
            </a>
        </div>
    </header>

    <main id="main-content" class="px-5 mt-4 space-y-6">
        <!-- AI Analyzer Section -->
        <section id="ai-view" class="space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-base font-bold">AI 함량 분석</h2>
                        <p class="text-[10px] text-gray-400">금 사진을 등록하고 분석하세요.</p>
                    </div>
                </div>

                <div id="image-display-area" class="hidden">
                    <div class="preview-container">
                        <div class="preview-square border-4 border-white">
                            <img id="main-preview-img" src="">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-2xl border-2 border-transparent focus-within:border-blue-500 transition-all">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">무게 입력 (돈)</label>
                        <input type="number" id="weight-input" value="1" step="0.01" class="bg-transparent border-0 w-full text-2xl font-black outline-none">
                    </div>

                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button id="main-action-btn" onclick="document.getElementById('image-input').click()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg flex items-center justify-center space-x-3 active:scale-95 transition-transform">
                        <i class="fas fa-camera"></i>
                        <span>사진 등록하기</span>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Error Modal (Reused Alert Modal) -->
    <div id="alert-modal" class="modal">
        <div class="modal-content text-center">
            <div class="py-4">
                <div id="alert-icon-box" class="w-14 h-14 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
                <h3 id="alert-title" class="text-lg font-black text-gray-900 mb-2">분석 오류</h3>
                <div id="alert-message-container" class="bg-gray-50 p-3 rounded-xl text-left">
                    <p id="alert-message" class="text-xs text-gray-600 leading-relaxed font-mono whitespace-pre-wrap"></p>
                </div>
                <p class="text-[10px] text-gray-400 mt-3 italic">위 내용을 스크린샷하여 관리자에게 문의해주세요.</p>
            </div>
            <button onclick="document.getElementById('alert-modal').classList.remove('active')" class="w-full py-4 mt-4 bg-gray-900 text-white rounded-2xl font-bold">확인</button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div id="result-body"></div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="resetAI()" class="py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-sm">다시하기</button>
                <a href="https://open.kakao.com/o/sDqGhjGb" target="_blank" class="py-4 bg-yellow-400 text-gray-900 rounded-2xl font-bold text-sm text-center">매각 상담</a>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="ad-modal" class="modal">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center py-8">
                <div class="loading-spinner mb-6"></div>
                <h3 class="text-lg font-black mb-2">AI 정밀 분석 중...</h3>
                <p class="text-xs text-gray-400">잠시만 기다려주세요.</p>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="crop-modal" class="modal">
        <div class="modal-content !max-w-[500px] !p-0">
            <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
                <span class="text-sm font-bold">금 부위 선택</span>
                <button onclick="closeCropModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="crop-area"><img id="crop-image" src=""></div>
            <div class="p-4 bg-white">
                <button onclick="applyCrop()" class="w-full py-4 bg-yellow-400 text-gray-900 font-black rounded-xl">이 부위로 분석</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        const apiKey = ""; // API Key (Runtime injected)
        let fullImageBase64 = null;
        let cropper = null;
        let goldPriceGram = 115000;

        function showError(msg, title = "분석 오류") {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('alert-modal').classList.add('active');
        }

        const imageInput = document.getElementById('image-input');
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('crop-image').src = event.target.result;
                document.getElementById('crop-modal').classList.add('active');
                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(document.getElementById('crop-image'), { viewMode: 1, aspectRatio: 1 });
                }, 100);
            };
            reader.readAsDataURL(file);
        });

        function closeCropModal() {
            document.getElementById('crop-modal').classList.remove('active');
            imageInput.value = "";
        }

        function applyCrop() {
            const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
            fullImageBase64 = canvas.toDataURL('image/jpeg');
            document.getElementById('image-display-area').classList.remove('hidden');
            document.getElementById('main-preview-img').src = fullImageBase64;
            
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.onclick = startAIAnalysis;
            actionBtn.innerHTML = `<i class="fas fa-brain"></i><span>AI 분석 시작하기</span>`;
            actionBtn.classList.replace('bg-gray-900', 'bg-blue-600');
            closeCropModal();
        }

        async function startAIAnalysis() {
            const weight = parseFloat(document.getElementById('weight-input').value);
            if (!weight || weight <= 0) return showError("무게를 정확히 입력해주세요.");
            
            document.getElementById('ad-modal').classList.add('active');
            
            const base64Data = fullImageBase64.split(',')[1];
            const systemPrompt = `귀금속 감정 전문가. 금의 품위(24K, 18K, 14K 등)를 분석. 응답은 반드시 JSON 형식을 준수할 것. JSON: { "karat": "24K", "confidence": 0.95, "reason": "색상과 광택이 순금에 가깝습니다.", "factor": 1.0 }`;

            try {
                // 1. API 키 확인
                if (!apiKey) {
                    throw new Error("환경 변수에 API Key가 설정되지 않았습니다. (Key is empty)");
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: `무게: ${weight}돈. 사진 속 금의 함량을 정밀 분석하라.` }, 
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ] 
                        }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                // 2. HTTP 응답 상태 확인
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errMsg = errorData.error?.message || response.statusText;
                    throw new Error(`[HTTP ${response.status}] ${errMsg}\n\n도움말: API 키 유효성 또는 네트워크 상태를 확인하세요.`);
                }

                const data = await response.json();
                
                // 3. 후보군 및 텍스트 데이터 존재 여부 확인
                const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResult) {
                    throw new Error("AI로부터 분석 결과를 받지 못했습니다. (Empty Result)");
                }

                const res = JSON.parse(textResult);
                const price = Math.floor(goldPriceGram * (weight * 3.75) * (res.factor || 0.5));
                
                setTimeout(() => {
                    document.getElementById('ad-modal').classList.remove('active');
                    showResult(res, price, weight);
                }, 1000);

            } catch (e) {
                document.getElementById('ad-modal').classList.remove('active');
                console.error("AI Error:", e);
                
                let detailedError = e.message;
                if (e instanceof SyntaxError) detailedError = "데이터 형식 오류: AI가 유효한 JSON을 생성하지 못했습니다.";
                
                showError(detailedError);
            }
        }

        function showResult(res, price, weight) {
            document.getElementById('result-body').innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-gem text-yellow-600 text-2xl"></i></div>
                    <h2 class="text-2xl font-black mb-1">${res.karat} 감정 결과</h2>
                    <p class="text-xs text-gray-400 mb-6">${weight}돈 분석 완료</p>
                    <div class="bg-gray-50 p-4 rounded-2xl mb-4 text-left">
                        <p class="text-[11px] font-bold text-gray-400 mb-1">AI 소견</p>
                        <p class="text-sm text-gray-600">${res.reason}</p>
                    </div>
                    <div class="bg-blue-600 p-6 rounded-3xl text-white shadow-lg">
                        <p class="text-[11px] font-bold opacity-70 mb-1">예상 매매가</p>
                        <p class="text-3xl font-black">₩ ${price.toLocaleString()}</p>
                    </div>
                </div>`;
            document.getElementById('result-modal').classList.add('active');
        }

        function resetAI() {
            document.getElementById('result-modal').classList.remove('active');
            document.getElementById('image-display-area').classList.add('hidden');
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.classList.replace('bg-blue-600', 'bg-gray-900');
            actionBtn.innerHTML = `<i class="fas fa-camera"></i><span>사진 등록하기</span>`;
            actionBtn.onclick = () => document.getElementById('image-input').click();
            document.getElementById('image-input').value = "";
            fullImageBase64 = null;
        }
    </script>
</body>
</html>
