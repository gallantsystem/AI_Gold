<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¸ˆ AI ë¶„ì„</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ê¸ˆ AI ë¶„ì„">
    
    <!-- Manifest (Inline for simplicity) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJnameIjogIuq4iCBBSSDrtoTshJ0iLAogICJzaG9ydF9uYW1lIjogIuq4iCBBSSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI3MjEvMjcyMTI5MC5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .marquee { overflow: hidden; white-space: nowrap; width: 100%; }
        .marquee-content { display: inline-block; animation: marquee 15s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-200%); } }
        
        .bottom-nav-item.active { color: #b8860b; font-weight: bold; }
        
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-left-color: #fbbf24; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { width: 100%; max-width: 400px; background: white; border-radius: 32px; padding: 24px; animation: fadeIn 0.3s ease-out; position: relative; overflow: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .preview-container { display: flex; justify-content: center; width: 100%; margin: 1rem 0; }
        .preview-square { width: 66.6%; aspect-ratio: 1/1; border-radius: 24px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); }
        .preview-square img { width: 100%; height: 100%; object-fit: cover; object-position: center; }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .crop-modal-content { width: 95%; max-width: 500px; padding: 0; }
        .crop-area { width: 100%; height: 350px; background: #000; }
        #crop-image { max-width: 100%; display: block; }
        
        main { flex: 1; overflow-y: auto; padding-bottom: 140px; }

        select { appearance: none; -webkit-appearance: none; }

        /* PWA Install Prompt Styling */
        #pwa-prompt { display: none; }
        #pwa-prompt.visible { display: flex; }
    </style>
</head>
<body>

    <!-- PWA Install Prompt -->
    <div id="pwa-prompt" class="fixed top-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl z-[60] flex items-center justify-between shadow-2xl animate-bounce">
        <div class="flex items-center">
            <div class="w-10 h-10 bg-yellow-400 rounded-lg flex items-center justify-center mr-3 text-gray-900">
                <i class="fas fa-gold"></i>
            </div>
            <div>
                <p class="text-xs font-bold">í™ˆ í™”ë©´ì— ì¶”ê°€</p>
                <p class="text-[10px] text-gray-400">ì•±ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì‹œì„¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
        </div>
        <button id="pwa-install-btn" class="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold">ì„¤ì¹˜</button>
    </div>

    <!-- Header & Top Marquee -->
    <header class="bg-white sticky top-0 z-50 shadow-sm shrink-0">
        <div class="px-4 py-3 flex items-center justify-between gap-2">
            <h1 class="text-base font-black text-gray-900 shrink-0">ê¸ˆ AI ë¶„ì„</h1>
            <div id="location-display" class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 flex items-center shrink-0">
                <i class="fas fa-location-arrow mr-1 text-blue-500"></i> <span>ìœ„ì¹˜ í™•ì¸ ì¤‘</span>
            </div>
            <a href="http://www.jaeilgoldhs.co.kr/" target="_blank" class="flex-1 bg-yellow-400 text-[11px] font-bold py-1.5 px-3 rounded-full text-center truncate shadow-sm">
                ê¸ˆíŒ”ëŸ¬ê°€ê¸° <i class="fas fa-chevron-right text-[9px] ml-0.5"></i>
            </a>
        </div>
        <div class="bg-gray-800 py-1.5 overflow-hidden">
            <div class="marquee"><div class="marquee-content text-[10px] text-yellow-200">[ê³µì§€] AI ë¶„ì„ ìˆ˜ì¹˜ëŠ” ì°¸ê³ ìš©ì´ë©° ì‹¤ë¬¼ ê°ì •ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.</div></div>
        </div>
    </header>

    <main id="main-content" class="px-5 mt-4 space-y-6">
        
        <!-- Standard Price Card -->
        <section id="price-section" class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-sm font-medium text-gray-500">ì˜¤ëŠ˜ì˜ í‘œì¤€ ì‹œì„¸</h2>
                    <p class="text-xs text-gray-400 mt-1">êµ­ë‚´ ê¸ˆ 99.99% (1ëˆ ê¸°ì¤€)</p>
                </div>
                <div class="bg-yellow-50 p-2 rounded-xl"><i class="fas fa-chart-line text-yellow-600"></i></div>
            </div>
            <div id="gold-don-price" class="text-3xl font-black text-gray-900">ë¡œë”© ì¤‘...</div>
        </section>

        <!-- AI Analyzer Section -->
        <section id="ai-view" class="space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-base font-bold">AI í•¨ëŸ‰ ë¶„ì„</h2>
                        <p class="text-[10px] text-gray-400">ê¸ˆ ì‚¬ì§„ì„ ë“±ë¡í•˜ê³  ë¶„ì„í•˜ì„¸ìš”.</p>
                    </div>
                </div>

                <div id="image-display-area" class="hidden">
                    <div class="preview-container">
                        <div class="preview-square border-4 border-white">
                            <img id="main-preview-img" src="">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-3">
                                <span class="text-white text-[10px] font-bold">ë¶„ì„ ëŒ€ìƒ ì‚¬ì§„</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="relative bg-gray-50 p-4 rounded-2xl border-2 border-transparent focus-within:border-blue-500 transition-all">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">ë¬´ê²Œ ì…ë ¥</label>
                            <div class="flex bg-gray-200 rounded-lg p-0.5">
                                <button onclick="setUnit('don', 'ai')" id="ai-unit-don-btn" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-blue-600 shadow-sm">ëˆ</button>
                                <button onclick="setUnit('gram', 'ai')" id="ai-unit-gram-btn" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500">g</button>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="weight-input" value="1" step="0.01" class="bg-transparent border-0 w-full text-2xl font-black outline-none">
                            <span id="ai-current-unit-label" class="text-lg font-bold text-gray-400 ml-2">ëˆ</span>
                        </div>
                    </div>

                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button id="main-action-btn" onclick="document.getElementById('image-input').click()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg flex items-center justify-center space-x-3 active:scale-95 transition-transform">
                        <i class="fas fa-camera"></i>
                        <span>ì‚¬ì§„ ë“±ë¡í•˜ê¸°</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Calculator View -->
        <section id="calc-view" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm space-y-5">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold flex items-center">
                        <span class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-2"><i class="fas fa-calculator text-yellow-600 text-sm"></i></span>
                        ê¸ˆ ì •ì‚° ê³„ì‚°ê¸°
                    </h2>
                    <div class="flex bg-gray-100 rounded-lg p-0.5 scale-90">
                        <button onclick="setUnit('don', 'calc')" id="calc-unit-don-btn" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-yellow-600 shadow-sm">ëˆ</button>
                        <button onclick="setUnit('gram', 'calc')" id="calc-unit-gram-btn" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500">g</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-2xl">
                        <label class="text-[11px] font-bold text-gray-400">ìˆœê¸ˆ (24K) ë¬´ê²Œ (<span class="calc-unit-text">ëˆ</span>)</label>
                        <input type="number" id="calc-w-24" placeholder="0.00" class="bg-transparent border-0 w-full text-lg font-bold outline-none">
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl">
                        <label class="text-[11px] font-bold text-gray-400">18K ë¬´ê²Œ (<span class="calc-unit-text">ëˆ</span>)</label>
                        <input type="number" id="calc-w-18" placeholder="0.00" class="bg-transparent border-0 w-full text-lg font-bold outline-none">
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl">
                        <label class="text-[11px] font-bold text-gray-400">14K ë¬´ê²Œ (<span class="calc-unit-text">ëˆ</span>)</label>
                        <input type="number" id="calc-w-14" placeholder="0.00" class="bg-transparent border-0 w-full text-lg font-bold outline-none">
                    </div>
                    <button onclick="runCalculation()" class="w-full py-5 bg-yellow-500 text-white rounded-2xl font-black text-xl shadow-lg">ê³„ì‚°í•˜ê¸°</button>
                </div>
            </div>
        </section>

        <!-- Alarm View -->
        <section id="alarm-view" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm">
                <h2 class="text-lg font-bold mb-5 flex items-center">
                    <span class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-2"><i class="fas fa-bell text-red-500 text-sm"></i></span>
                    ì‹œì„¸ ì•ŒëŒ ì„¤ì •
                </h2>
                <p class="text-xs text-gray-400 mb-6 text-center leading-relaxed">ì„¤ì •í•˜ì‹  ì‹œê°„ì— ì˜¤ëŠ˜ì˜ ê¸ˆ ì‹œì„¸ë¥¼<br>íŒì—…ìœ¼ë¡œ ìƒì„¸íˆ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.</p>
                
                <div class="flex items-center justify-between space-x-2 mb-8">
                    <div class="flex-1 bg-gray-50 rounded-2xl overflow-hidden relative border border-gray-100">
                        <select id="alarm-ampm" class="w-full p-4 bg-transparent text-center font-bold outline-none relative z-10">
                            <option value="AM">ì˜¤ì „</option>
                            <option value="PM" selected>ì˜¤í›„</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-400"></i>
                    </div>
                    <div class="flex-1 bg-gray-50 rounded-2xl overflow-hidden relative border border-gray-100">
                        <select id="alarm-hour" class="w-full p-4 bg-transparent text-center font-bold outline-none relative z-10">
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-400"></i>
                    </div>
                    <span class="font-bold text-gray-300">:</span>
                    <div class="flex-1 bg-gray-50 rounded-2xl overflow-hidden relative border border-gray-100">
                        <select id="alarm-minute" class="w-full p-4 bg-transparent text-center font-bold outline-none relative z-10">
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-400"></i>
                    </div>
                </div>

                <div id="alarm-status" class="hidden text-center mb-4 p-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold">
                    ğŸ”” ì‹œì„¸ ì•ŒëŒì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>

                <button onclick="saveAlarm()" class="w-full py-4 bg-red-500 text-white rounded-2xl font-bold shadow-md active:scale-95 transition-transform">ì•ŒëŒ ì €ì¥</button>
            </div>
        </section>

    </main>

    <!-- Bottom Marquee -->
    <div class="fixed bottom-20 left-0 w-full bg-white border-t border-gray-100 py-2 overflow-hidden z-40">
        <div class="marquee">
            <div class="marquee-content text-[11px] text-gray-500 flex items-center space-x-8">
                <span>ğŸ¢ [ì¢…ë¡œê¸ˆê±°ë˜ì†Œ í™”ì„±ì ] 031-356-1077</span>
                <span>ğŸ’ [í•œêµ­í‘œì¤€ê¸ˆê±°ë˜ì†Œ] ìµœê³ ê°€ ë§¤ì… ì „ë¬¸</span>
                <span>ğŸ¥‡ [í™”ì„± ê¸ˆì€ë°©] ê¸ˆÂ·ì€Â·ë‹¤ì´ì•„ëª¬ë“œ ê³ ê°€ ë§¤ìˆ˜</span>
                <span>ğŸ“ [ìƒë‹´] 24ì‹œê°„ ì‹¤ì‹œê°„ ì¹´í†¡ ìƒë‹´ ê°€ëŠ¥</span>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t flex justify-around items-center h-20 px-1 z-50">
        <button onclick="switchView('ai')" id="nav-ai" class="bottom-nav-item flex flex-col items-center flex-1 active">
            <i class="fas fa-microchip text-xl mb-1"></i><span class="text-[9px]">AI ë¶„ì„</span>
        </button>
        <button onclick="switchView('calc')" id="nav-calc" class="bottom-nav-item flex flex-col items-center flex-1">
            <i class="fas fa-calculator text-xl mb-1"></i><span class="text-[9px]">ê¸ˆê³„ì‚°ê¸°</span>
        </button>
        <button onclick="switchView('alarm')" id="nav-alarm" class="bottom-nav-item flex flex-col items-center flex-1">
            <i class="fas fa-bell text-xl mb-1"></i><span class="text-[9px]">ì•ŒëŒì„¤ì •</span>
        </button>
        <a href="https://open.kakao.com/o/sDqGhjGb" target="_blank" class="bottom-nav-item flex flex-col items-center flex-1 text-yellow-600">
            <i class="fas fa-comment text-xl mb-1"></i><span class="text-[9px]">ì¹´í†¡ìƒë‹´</span>
        </a>
        <a href="tel:031-356-1077" class="bottom-nav-item flex flex-col items-center flex-1 text-red-500">
            <i class="fas fa-phone-alt text-xl mb-1"></i><span class="text-[9px]">ì „í™”ìƒë‹´</span>
        </a>
    </nav>

    <!-- Modals -->
    <div id="alert-modal" class="modal">
        <div class="modal-content text-center">
            <div class="py-4">
                <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-info-circle text-2xl"></i>
                </div>
                <h3 id="alert-title" class="text-lg font-black text-gray-900 mb-2">ì•ˆë‚´</h3>
                <p id="alert-message" class="text-sm text-gray-500 leading-relaxed px-4"></p>
            </div>
            <button onclick="document.getElementById('alert-modal').classList.remove('active')" class="w-full py-4 mt-4 bg-gray-900 text-white rounded-2xl font-bold">í™•ì¸</button>
        </div>
    </div>

    <div id="alarm-popup-modal" class="modal">
        <div class="modal-content">
            <div class="text-center p-2">
                <div class="inline-block bg-red-100 text-red-600 text-[10px] font-bold px-3 py-1 rounded-full mb-2">ì•ŒëŒ: ì˜¤ëŠ˜ì˜ ì‹œì„¸</div>
                <h2 class="text-xl font-black text-gray-900 mb-1">ì˜¤ëŠ˜ì˜ í‘œì¤€ ì‹œì„¸ í™•ì¸</h2>
                <p id="popup-date" class="text-[11px] text-gray-400 mb-6">ê¸°ì¤€ ì‹œê°„ ë¡œë”© ì¤‘...</p>
                <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-gray-500">ìˆœê¸ˆ (24K) / 1ëˆ</span>
                        <span id="popup-24k-price" class="text-lg font-black text-yellow-600">ë¡œë”© ì¤‘...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-500">ìˆœê¸ˆ (24K) / 1g</span>
                        <span id="popup-1g-price" class="text-sm font-bold text-gray-700">ë¡œë”© ì¤‘...</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('alarm-popup-modal').classList.remove('active')" class="py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-sm">ë‹«ê¸°</button>
                    <a href="tel:031-356-1077" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-sm text-center shadow-lg">ìƒë‹´í•˜ê¸°</a>
                </div>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div id="result-body"></div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="resetAI()" class="py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-sm">ë‹¤ì‹œí•˜ê¸°</button>
                <a href="https://open.kakao.com/o/sDqGhjGb" target="_blank" class="py-4 bg-yellow-400 text-gray-900 rounded-2xl font-bold text-sm text-center">ë§¤ê° ìƒë‹´</a>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="modal">
        <div class="modal-content crop-modal-content">
            <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
                <span class="text-sm font-bold">ê¸ˆ ë¶€ìœ„ ì„ íƒ (í¬ë¡­)</span>
                <button onclick="closeCropModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="crop-area"><img id="crop-image" src=""></div>
            <div class="p-4 bg-white">
                <button onclick="applyCrop()" class="w-full py-4 bg-yellow-400 text-gray-900 font-black rounded-xl shadow-lg">ì´ ë¶€ìœ„ë¡œ ë¶„ì„</button>
            </div>
        </div>
    </div>

    <div id="ad-modal" class="modal">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center py-8">
                <div class="loading-spinner mb-6"></div>
                <h3 class="text-lg font-black mb-2">AI ì •ë°€ ë¶„ì„ ì¤‘...</h3>
                <p class="text-xs text-gray-400 mb-8">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì‹œë©´ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/config.js" onerror="console.warn('config.js íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        function showAlert(message, title = "ì•ˆë‚´") {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.add('active');
        }

        const APP_CONFIG = {
            getGeminiKey: () => (typeof CONFIG !== 'undefined' && CONFIG.GEMINI_API_KEY) ? CONFIG.GEMINI_API_KEY : "",
            getServiceKey: () => (typeof CONFIG !== 'undefined' && CONFIG.PUBLIC_DATA_SERVICE_KEY) ? CONFIG.PUBLIC_DATA_SERVICE_KEY : "",
            getKakaoKey: () => (typeof CONFIG !== 'undefined' && CONFIG.KAKAO_REST_API_KEY) ? CONFIG.KAKAO_REST_API_KEY : "818e95777719602330a66d03f5637257"
        };

        let goldPriceGram = 118500; 
        let aiCurrentUnit = 'don';
        let calcCurrentUnit = 'don';
        let fullImageBase64 = null;
        let cropper = null;
        let savedAlarm = null;

        async function updateCurrentLocation() {
            const locationSpan = document.querySelector('#location-display span');
            if (!navigator.geolocation) {
                locationSpan.textContent = "ìœ„ì¹˜ ì§€ì› ë¶ˆê°€";
                return;
            }
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const kakaoKey = APP_CONFIG.getKakaoKey();
                if (!kakaoKey) return;
                try {
                    const response = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2regioncode.json?x=${lng}&y=${lat}`, {
                        headers: { 'Authorization': `KakaoAK ${kakaoKey}` }
                    });
                    const data = await response.json();
                    if (data.documents && data.documents.length > 0) {
                        const region = data.documents.find(d => d.region_type === 'H') || data.documents[0];
                        locationSpan.textContent = `${region.region_1depth_name} ${region.region_2depth_name}`;
                    }
                } catch (e) { console.error(e); }
            });
        }

        async function fetchPrice() {
            const serviceKey = APP_CONFIG.getServiceKey();
            if (!serviceKey) { updatePriceUI(); return; }
            try {
                const url = `https://apis.data.go.kr/1160100/service/GetGeneralProductInfoService/getGoldPriceInfo?serviceKey=${serviceKey}&resultType=json&numOfRows=1&itmsNm=%EA%B8%88%2099.99_1Kg`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.response?.body?.items?.item?.[0]?.clpr) {
                    goldPriceGram = parseFloat(data.response.body.items.item[0].clpr);
                }
            } catch (e) { console.error(e); } finally { updatePriceUI(); }
        }

        function updatePriceUI() {
            const donPriceStr = Math.floor(goldPriceGram * 3.75).toLocaleString();
            const goldPriceEl = document.getElementById('gold-don-price');
            if(goldPriceEl) goldPriceEl.innerHTML = `<span class="text-yellow-600 font-black">${donPriceStr}</span><span class="text-sm font-bold text-gray-400">ì›</span>`;
            const p24 = document.getElementById('popup-24k-price');
            const p1g = document.getElementById('popup-1g-price');
            if(p24) p24.textContent = donPriceStr + "ì›";
            if(p1g) p1g.textContent = goldPriceGram.toLocaleString() + "ì›";
        }

        function setUnit(unit, view) {
            if (view === 'ai') {
                if (aiCurrentUnit === unit) return;
                aiCurrentUnit = unit;
                const input = document.getElementById('weight-input');
                const label = document.getElementById('ai-current-unit-label');
                input.value = unit === 'don' ? (input.value / 3.75).toFixed(2) : (input.value * 3.75).toFixed(2);
                document.getElementById('ai-unit-don-btn').className = unit === 'don' ? "px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-blue-600 shadow-sm" : "px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500";
                document.getElementById('ai-unit-gram-btn').className = unit === 'gram' ? "px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-blue-600 shadow-sm" : "px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500";
                label.textContent = unit === 'don' ? "ëˆ" : "g";
            } else if (view === 'calc') {
                if (calcCurrentUnit === unit) return;
                calcCurrentUnit = unit;
                const ids = ['calc-w-24', 'calc-w-18', 'calc-w-14'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el.value) el.value = unit === 'don' ? (el.value / 3.75).toFixed(2) : (el.value * 3.75).toFixed(2);
                });
                document.getElementById('calc-unit-don-btn').className = unit === 'don' ? "px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-yellow-600 shadow-sm" : "px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500";
                document.getElementById('calc-unit-gram-btn').className = unit === 'gram' ? "px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-white text-yellow-600 shadow-sm" : "px-3 py-1 text-[10px] font-bold rounded-md transition-all text-gray-500";
                document.querySelectorAll('.calc-unit-text').forEach(l => l.textContent = unit === 'don' ? "ëˆ" : "g");
            }
        }

        const imageInput = document.getElementById('image-input');
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                fullImageBase64 = event.target.result;
                document.getElementById('crop-image').src = event.target.result;
                document.getElementById('crop-modal').classList.add('active');
                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(document.getElementById('crop-image'), { viewMode: 1, aspectRatio: 1, autoCropArea: 0.8 });
                }, 100);
            };
            reader.readAsDataURL(file);
        });

        function closeCropModal() {
            document.getElementById('crop-modal').classList.remove('active');
            imageInput.value = "";
        }

        function applyCrop() {
            const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
            document.getElementById('price-section').classList.add('hidden');
            document.getElementById('image-display-area').classList.remove('hidden');
            document.getElementById('main-preview-img').src = canvas.toDataURL('image/jpeg');
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.onclick = startAIAnalysis;
            actionBtn.innerHTML = `<i class="fas fa-brain"></i><span>AI ë¶„ì„ ì‹œì‘í•˜ê¸°</span>`;
            actionBtn.classList.replace('bg-gray-900', 'bg-blue-600');
            closeCropModal();
        }

        async function startAIAnalysis() {
            const apiKey = APP_CONFIG.getGeminiKey();
            if (!apiKey) return showAlert("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            const weight = parseFloat(document.getElementById('weight-input').value);
            if (!weight || weight <= 0) return showAlert("ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            document.getElementById('ad-modal').classList.add('active');
            const gramWeight = aiCurrentUnit === 'don' ? weight * 3.75 : weight;
            const base64Data = fullImageBase64.split(',')[1];
            const systemPrompt = `ê·€ê¸ˆì† ê°ì • ì „ë¬¸ê°€. ê¸ˆì˜ í’ˆìœ„(Karat)ë¥¼ ì •ë°€ ë¶„ì„. JSON format: { "karat": "24K"|"18K"|"14K"|"ê¸°íƒ€", "confidence": number, "reason": string, "factor": number }`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ë¬´ê²Œ: ${gramWeight}g. í•¨ëŸ‰ ë¶„ì„ ìš”ë§.` }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                const res = JSON.parse(data.candidates[0].content.parts[0].text);
                const price = Math.floor(goldPriceGram * gramWeight * (res.factor || 0.5));
                setTimeout(() => {
                    document.getElementById('ad-modal').classList.remove('active');
                    showResult(res, price, gramWeight);
                }, 1500);
            } catch (e) {
                document.getElementById('ad-modal').classList.remove('active');
                showAlert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        function showResult(res, price, weight) {
            document.getElementById('result-body').innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-gem text-yellow-600 text-2xl"></i></div>
                    <h2 class="text-2xl font-black mb-1">${res.karat} ê°ì • ê²°ê³¼</h2>
                    <p class="text-xs text-gray-400 mb-6">${weight.toFixed(2)}g ë¶„ì„ ì™„ë£Œ</p>
                    <div class="bg-gray-50 p-4 rounded-2xl mb-4 text-left">
                        <p class="text-[11px] font-bold text-gray-400 mb-1">AI ì†Œê²¬</p>
                        <p class="text-sm text-gray-600">${res.reason}</p>
                    </div>
                    <div class="bg-blue-600 p-6 rounded-3xl text-white shadow-lg">
                        <p class="text-[11px] font-bold opacity-70 mb-1">ì˜ˆìƒ ë§¤ë§¤ê°€</p>
                        <p class="text-3xl font-black">â‚© ${price.toLocaleString()}</p>
                    </div>
                </div>`;
            document.getElementById('result-modal').classList.add('active');
        }

        /**
         * ë‹¤ì‹œí•˜ê¸° ê¸°ëŠ¥ (ì´ˆê¸°í™”)
         */
        function resetAI() {
            // 1. ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('result-modal').classList.remove('active');
            
            // 2. ìƒë‹¨ ì‹œì„¸ ì¹´ë“œ í‘œì‹œ ë° ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('price-section').classList.remove('hidden');
            document.getElementById('image-display-area').classList.add('hidden');
            
            // 3. ë©”ì¸ ë²„íŠ¼ ìƒíƒœ ë³µêµ¬ (ìƒ‰ìƒ, í…ìŠ¤íŠ¸, ì•„ì´ì½˜)
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.classList.remove('bg-blue-600');
            actionBtn.classList.add('bg-gray-900');
            actionBtn.innerHTML = `<i class="fas fa-camera"></i><span>ì‚¬ì§„ ë“±ë¡í•˜ê¸°</span>`;
            
            // 4. ë©”ì¸ ë²„íŠ¼ì˜ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ íŒŒì¼ ì„ íƒìœ¼ë¡œ ë³€ê²½
            actionBtn.onclick = () => document.getElementById('image-input').click();
            
            // 5. ì…ë ¥ í•„ë“œ ë° ë‚´ë¶€ ë°ì´í„° ì´ˆê¸°í™”
            document.getElementById('image-input').value = "";
            document.getElementById('main-preview-img').src = "";
            fullImageBase64 = null;
        }

        function switchView(view) {
            ['ai', 'calc', 'alarm'].forEach(v => {
                document.getElementById(`${v}-view`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`${view}-view`).classList.remove('hidden');
            document.getElementById(`nav-${view}`).classList.add('active');
        }

        function runCalculation() {
            const w24 = parseFloat(document.getElementById('calc-w-24').value) || 0;
            const w18 = parseFloat(document.getElementById('calc-w-18').value) || 0;
            const w14 = parseFloat(document.getElementById('calc-w-14').value) || 0;
            const mult = calcCurrentUnit === 'don' ? 3.75 : 1;
            const total = Math.floor(((w24 * mult) * goldPriceGram * 0.98) + ((w18 * mult) * goldPriceGram * 0.75 * 0.95) + ((w14 * mult) * goldPriceGram * 0.585 * 0.95));
            showAlert(`ì˜ˆìƒ ì •ì‚° ê¸ˆì•¡ì€ ì•½ ${total.toLocaleString()}ì› ì…ë‹ˆë‹¤.`, "ì •ì‚° ê²°ê³¼");
        }

        function saveAlarm() {
            const ampm = document.getElementById('alarm-ampm').value;
            const hour = parseInt(document.getElementById('alarm-hour').value);
            const min = parseInt(document.getElementById('alarm-minute').value);
            let h24 = (ampm === 'PM' && hour !== 12) ? hour + 12 : (ampm === 'AM' && hour === 12 ? 0 : hour);
            savedAlarm = { hour: h24, minute: min, label: `${ampm} ${hour}:${min < 10 ? '0'+min : min}` };
            document.getElementById('alarm-status').classList.remove('hidden');
            document.getElementById('alarm-status').textContent = `ğŸ”” ${savedAlarm.label} ì‹œì„¸ ì•ŒëŒ ì˜ˆì•½ ì™„ë£Œ`;
            showAlert(`${savedAlarm.label}ì— ì‹œì„¸ í™•ì¸ ì•ŒëŒì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, "ì•ŒëŒ ì„¤ì • ì™„ë£Œ");
        }

        window.onload = () => {
            fetchPrice();
            updateCurrentLocation();
            const hs = document.getElementById('alarm-hour');
            const ms = document.getElementById('alarm-minute');
            for(let i=1; i<=12; i++) hs.add(new Option(i+'ì‹œ', i));
            for(let i=0; i<60; i+=5) ms.add(new Option((i<10?'0'+i:i)+'ë¶„', i));
        };
    </script>
</body>
</html>
