<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>금 AI 분석시스템</title>
    
    <!-- PWA 설정 -->
    <meta name="theme-color" content="#f59e0b">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js');
    });
  }
</script>

    <!-- 외부 라이브러리 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 아이콘 -->
    <script src="https://unpkg.com/lucide@latest"></script>




    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee { animation: marquee 25s linear infinite; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .btn-active-glow {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            animation: pulse-amber 2s infinite;
        }
        @keyframes pulse-amber {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        /**
         * Icon 컴포넌트: 
         * Lucide 아이콘 데이터를 수동으로 파싱하여 React 엘리먼트로 변환합니다.
         * 객체 구조 분해 에러와 map 에러를 방지하기 위해 타입 체크를 강화했습니다.
         */
        const Icon = ({ name, size = 24, className = "" }) => {
            const getIconContent = (iconName) => {
                const camelName = iconName.charAt(0).toUpperCase() + 
                                  iconName.slice(1).replace(/-([a-z])/g, g => g[1].toUpperCase());
                
                const iconDef = window.lucide ? window.lucide[camelName] : null;
                
                // Lucide 아이콘 데이터 구조 검증 및 렌더링
                if (iconDef && Array.isArray(iconDef) && iconDef[2]) {
                    return iconDef[2].map((child, i) => {
                        if (!Array.isArray(child) || child.length < 2) return null;
                        const Tag = child[0];
                        const attrs = child[1];
                        return <Tag key={i} {...attrs} />;
                    });
                }
                
                // 폴백 아이콘 (기본 원형)
                return <circle cx="12" cy="12" r="10" />;
            };

            const content = useMemo(() => getIconContent(name), [name]);

            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    className={`lucide-icon ${className}`}
                >
                    {content}
                </svg>
            );
        };

        const App = () => {
            const apiKey = "AIzaSyAO8PsCWMq0xLtiywqqK90AD1NHP_84-us"; 
            const [krxPrice, setKrxPrice] = useState(123500); 
            const [isLoadingPrice, setIsLoadingPrice] = useState(false);
            const [image, setImage] = useState(null);
            const [croppedImage, setCroppedImage] = useState(null);
            const [base64Image, setBase64Image] = useState(null);
            const [prediction, setPrediction] = useState(null);
            const [unit, setUnit] = useState('don');
            const [inputValue, setInputValue] = useState(1);
            const [weightInGrams, setWeightInGrams] = useState(3.75);
            const [isCropping, setIsCropping] = useState(false);
            const [crop, setCrop] = useState({ x: 25, y: 25, width: 50, height: 50 });
            const [isNoticeOpen, setIsNoticeOpen] = useState(true);
            const [isAdOpen, setIsAdOpen] = useState(false);
            const [adTimer, setAdTimer] = useState(15);
            const [isAnalysisComplete, setIsAnalysisComplete] = useState(false);

            const fetchKrxGoldPrice = useCallback(async () => {
                setIsLoadingPrice(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "현재 한국거래소(KRX) 금 시장의 1g당 매매가격을 숫자로만 알려주세요. 예: 123500" }] }],
                            tools: [{ "google_search": {} }]
                        })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "123500";
                    const price = parseInt(text.replace(/[^0-9]/g, ''));
                    if (!isNaN(price) && price > 10000) {
                        setKrxPrice(price);
                    }
                } catch (error) {
                    console.error("Price fetch error:", error);
                } finally {
                    setIsLoadingPrice(false);
                }
            }, [apiKey]);

            useEffect(() => {
                fetchKrxGoldPrice();
            }, [fetchKrxGoldPrice]);

            const getStandardDonPrice = () => krxPrice * 3.75;

            const calculatePrice = () => {
                if (!prediction || !prediction.purity) return "0";
                const base = getStandardDonPrice();
                let ratio = 0;
                const p = String(prediction.purity).toUpperCase();
                if (p.includes('24K')) ratio = 0.95;
                else if (p.includes('18K')) ratio = 0.735;
                else if (p.includes('14K')) ratio = 0.57;
                else if (p.includes('10K')) ratio = 0.41;
                else if (p.includes('은')) ratio = 0.05;
                else ratio = 0.90;
                return Math.floor((base * ratio / 3.75) * weightInGrams).toLocaleString();
            };

            const handleImage = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setImage(event.target.result);
                    setIsCropping(true);
                    setCrop({ x: 25, y: 25, width: 50, height: 50 });
                };
                reader.readAsDataURL(file);
            };

            const getCroppedImg = () => {
                const img = new Image();
                img.src = image;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scaleX = img.naturalWidth / 100;
                    const scaleY = img.naturalHeight / 100;
                    canvas.width = Math.max(1, crop.width * scaleX);
                    canvas.height = Math.max(1, crop.height * scaleY);
                    ctx.drawImage(img, crop.x * scaleX, crop.y * scaleY, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    setCroppedImage(base64);
                    setBase64Image(base64.split(',')[1]);
                    setIsCropping(false);
                };
            };

            const startAnalysis = async () => {
                if (!base64Image) return;
                setIsAnalysisComplete(false);
                setPrediction(null);
                setIsAdOpen(true);
                setAdTimer(15);
                
                const itv = setInterval(() => {
                    setAdTimer(t => { 
                        if (t <= 1) { 
                            clearInterval(itv); 
                            return 0; 
                        } 
                        return t - 1; 
                    });
                }, 1000);

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [
                                { text: "이미지를 분석하여 다음 JSON 형식으로만 응답하세요. 모든 값은 한글이어야 합니다. 함량은 반드시 '24K', '18K', '14K' 등의 형식을 포함해야 합니다: { \"productName\": \"제품명\", \"purity\": \"함량\", \"reason\": \"상세 분석 이유\" }" },
                                { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                            ]}]
                        })
                    });
                    const data = await res.json();
                    
                    if (!res.ok) throw new Error("API_ERROR");

                    const rawTxt = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const cleanTxt = rawTxt.replace(/```json|```/g, '').trim();
                    const parsed = JSON.parse(cleanTxt);
                    
                    setPrediction(parsed);
                    setIsAnalysisComplete(true);
                } catch (e) {
                    console.error("Analysis Error:", e);
                    setPrediction({ 
                        productName: "분석 실패", 
                        purity: "확인불가", 
                        reason: "이미지 인식이 원활하지 않거나 서버 연결이 지연되었습니다. 다시 시도해주세요." 
                    });
                    setIsAnalysisComplete(true);
                }
            };

            const resetAnalysis = () => {
                setImage(null);
                setCroppedImage(null);
                setPrediction(null);
                setIsAnalysisComplete(false);
            };

            return (
                <div className="pb-32 select-none min-h-screen">
                    {isNoticeOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-xs w-full text-center shadow-2xl">
                                <div className="flex justify-center mb-4">
                                    <Icon name="bell" size={40} className="text-amber-500" />
                                </div>
                                <h3 className="text-xl font-bold mb-2">AI 분석 주의사항</h3>
                                <p className="text-sm text-slate-500 mb-6 leading-relaxed">한국거래소(KRX) 실시간 금 시세를 기준으로 추정가를 계산하며, 실제 감정가와는 차이가 있을 수 있습니다.</p>
                                <button onClick={() => setIsNoticeOpen(false)} className="w-full bg-amber-500 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform">동의하고 시작</button>
                            </div>
                        </div>
                    )}

                    <nav className="bg-white border-b sticky top-0 z-40 max-w-md mx-auto shadow-sm">
                        <div className="px-5 py-4 flex justify-between items-center">
                            <h1 className="font-black text-xl flex items-center gap-2 text-slate-800" onClick={resetAnalysis}>
                                <Icon name="coins" size={24} className="text-amber-500" /> 금 AI 분석시스템
                            </h1>
                            <button onClick={fetchKrxGoldPrice} className={`p-2 rounded-full ${isLoadingPrice ? 'animate-spin' : ''}`}>
                                <Icon name="refresh-cw" size={18} className="text-slate-400" />
                            </button>
                        </div>
                        <div className="bg-amber-500 py-2 overflow-hidden">
                            <div className="flex whitespace-nowrap animate-marquee items-center gap-8">
                                <p className="text-[11px] font-black text-slate-900 flex items-center gap-2">
                                    <Icon name="megaphone" size={12}/> [실시간 시세] KRX 금 시장 데이터를 성공적으로 수신 중입니다.
                                </p>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto p-5 space-y-5">
                        <section className="bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl relative overflow-hidden border border-white/10">
                            <p className="text-[10px] font-black text-amber-500/80 tracking-widest uppercase mb-1">KRX Gold Market Rate</p>
                            <div className="flex items-baseline gap-2">
                                <h2 className="text-4xl font-black text-white italic">₩ {getStandardDonPrice().toLocaleString()}</h2>
                                <span className="text-[11px] font-bold text-amber-400">/ 1돈(3.75g)</span>
                            </div>
                            <div className="flex items-center gap-2 mt-4 text-[9px] font-bold text-slate-400">
                                <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                                Live Connected
                            </div>
                        </section>

                        {prediction && !isAdOpen && (
                            <section className="bg-white rounded-[2rem] p-6 shadow-xl border-2 border-amber-500 transition-all">
                                <h3 className="text-sm font-black text-slate-800 flex items-center gap-2 mb-5">
                                    <Icon name="search" size={18} className="text-amber-500" /> AI 정밀 분석 리포트
                                </h3>
                                <div className="grid grid-cols-2 gap-3 mb-5">
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                        <p className="text-[10px] font-black text-slate-400 mb-1">제품명</p>
                                        <p className="text-sm font-black text-slate-800 truncate">{prediction.productName}</p>
                                    </div>
                                    <div className="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                                        <p className="text-[10px] font-black text-amber-400 mb-1">식별 함량</p>
                                        <p className="text-sm font-black text-amber-600">{prediction.purity}</p>
                                    </div>
                                </div>
                                <div className="bg-slate-900 rounded-2xl p-5 text-center mb-5">
                                    <p className="text-[10px] font-black text-amber-500 mb-1 uppercase">매입 예상가 (추정)</p>
                                    <h4 className="text-3xl font-black text-white tracking-tighter">₩ {calculatePrice()}</h4>
                                </div>
                                <p className="text-[11px] font-bold text-slate-500 leading-relaxed italic text-center px-2">"{prediction.reason}"</p>
                            </section>
                        )}

                        <section className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                            {!image ? (
                                <div className="aspect-[16/7] border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center bg-slate-50 relative group transition-colors hover:bg-slate-100">
                                    <Icon name="camera" size={32} className="text-amber-500 mb-2" />
                                    <p className="text-xs font-black text-slate-800">제품 각인 부위가 보이게 촬영</p>
                                    <input type="file" accept="image/*" capture="environment" onChange={handleImage} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            ) : isCropping ? (
                                <div className="space-y-4">
                                    <div className="aspect-video bg-slate-900 rounded-2xl overflow-hidden relative">
                                        <img src={image} className="w-full h-full object-contain opacity-70" alt="원본" />
                                        <div className="absolute border-4 border-amber-400 shadow-[0_0_0_9999px_rgba(0,0,0,0.6)]" 
                                            style={{ left: `${crop.x}%`, top: `${crop.y}%`, width: `${crop.width}%`, height: `${crop.height}%` }}></div>
                                    </div>
                                    <button onClick={getCroppedImg} className="w-full bg-amber-500 text-white py-4 rounded-xl font-black shadow-lg">이 부위 분석하기</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="relative">
                                        <img src={croppedImage} className="w-full h-40 object-cover rounded-2xl shadow-md border-2 border-white" alt="크롭" />
                                        <button onClick={() => setImage(null)} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><Icon name="x" size={16}/></button>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-2xl space-y-4">
                                        <div className="flex bg-white p-1 rounded-xl shadow-inner text-center">
                                            <button onClick={() => {setUnit('don'); setInputValue(weightInGrams/3.75);}} className={`flex-1 py-2 rounded-lg text-xs font-black ${unit === 'don' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-400'}`}>돈(don)</button>
                                            <button onClick={() => {setUnit('g'); setInputValue(weightInGrams);}} className={`flex-1 py-2 rounded-lg text-xs font-black ${unit === 'g' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-400'}`}>그램(g)</button>
                                        </div>
                                        <div className="flex items-center justify-center gap-2 py-2">
                                            <input type="number" step="0.01" value={inputValue} onChange={e => {
                                                const val = parseFloat(e.target.value) || 0;
                                                setInputValue(val);
                                                setWeightInGrams(unit === 'don' ? val * 3.75 : val);
                                            }} className="w-24 text-center font-black text-4xl border-b-2 border-amber-500 outline-none bg-transparent" />
                                            <span className="font-black text-xl text-slate-300">{unit}</span>
                                        </div>
                                    </div>
                                    <button onClick={startAnalysis} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 flex items-center justify-center gap-2">
                                        <Icon name="search" size={20} /> AI 정밀 분석 시작
                                    </button>
                                </div>
                            )}
                        </section>
                    </main>

                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-5 z-40">
                        <div className="bg-slate-900/95 backdrop-blur-2xl p-3 rounded-[2.2rem] flex items-center justify-between shadow-2xl border border-white/10">
                            <div className="flex items-center gap-3 ml-2">
                                <div className="w-11 h-11 rounded-2xl bg-amber-500 flex items-center justify-center text-slate-900">
                                    <Icon name="phone" size={22} className="animate-pulse" />
                                </div>
                                <div>
                                    <p className="text-[13px] font-black text-white">실시간 고가 매입상담</p>
                                    <p className="text-[10px] font-bold text-amber-500/80">Expert 1:1 Connection</p>
                                </div>
                            </div>
                            <button className="bg-amber-500 text-slate-900 px-7 py-3.5 rounded-2xl font-black text-xs">상담 신청</button>
                        </div>
                    </div>

                    {isAdOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/98 p-6 backdrop-blur-md">
                            <div className="bg-white rounded-[3rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-slate-100">
                                    <div className="h-full bg-amber-500 transition-all duration-1000 ease-linear" style={{ width: `${((15-adTimer)/15)*100}%` }}></div>
                                </div>
                                <div className="flex justify-center mb-6 mt-4">
                                    <Icon name="shield-check" size={56} className="text-amber-500" />
                                </div>
                                <h4 className="text-2xl font-black mb-2 uppercase tracking-tighter">AI 분석 가동 중</h4>
                                <div className="my-8 py-6 px-4 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200">
                                    <Icon name="megaphone" size={24} className="mx-auto text-amber-500 mb-3 animate-bounce" />
                                    <p className="font-black text-slate-800 text-sm">함량 식별 및 시세 대조 중...</p>
                                </div>
                                <div className="space-y-3">
                                    {isAnalysisComplete ? (
                                        <button onClick={() => setIsAdOpen(false)} className="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black text-lg shadow-xl btn-active-glow">결과 확인하기</button>
                                    ) : (
                                        <div className="flex flex-col items-center gap-2">
                                            <div className="flex items-center gap-3 text-amber-600 font-black">
                                                <Icon name="loader-2" size={20} className="animate-spin" />
                                                <span>데이터 스캔 중... {adTimer}s</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>